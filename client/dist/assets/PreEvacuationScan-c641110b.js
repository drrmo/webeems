import{j as R,u as We,a as Le,y as Be,r as m,a2 as Qe,a3 as Oe,a4 as Fe,a5 as ze,b as a,a6 as Ze,L as Ve}from"./index-a50eb7ee.js";/* empty css                      */import{w as Ye,S as _e}from"./sweetalert2.all-953600d6.js";import{C as qe,a as Ge,Q as Je,L as Ke}from"./ListOccupants-8a7778c2.js";import{B as Ue}from"./Breadcrumb-c6b78098.js";import{F as He,C as $e}from"./FormControlLabel-03ccc167.js";import{A as Xe}from"./Alert-5e12cda2.js";import"./useFormControl-323236cf.js";import"./useControlled-20eeda9a.js";function na(){return window.document.title="QR Scanning (Pre-Evacuation) | WebEEMS",R({})}function da(){var F,z,Z,V,Y,_,q,G,J,K,U,X,I,ee,ae,te,se,ie,re,le,ce,ne,de,ue,oe,me,he,ge,pe,xe,Ee,ye,be,ve,je,De,fe,Ne,Pe;const r=We(),A=Le(),N=Be(),[e,T]=m.useState({}),[s,v]=m.useState({}),[j,p]=m.useState(null),[P,W]=m.useState(!1),[M,Se]=m.useState(null),[E,y]=m.useState([]),[H,$]=m.useState(!1),[b,x]=m.useState(!1),[L,we]=m.useState(!1),S=Ye(_e),h=S.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:5e3,timerProgressBar:!0,didOpen:t=>{t.addEventListener("mouseenter",S.stopTimer),t.addEventListener("mouseleave",S.resumeTimer)}}),B=S.mixin({input:"text",inputAttributes:{autocapitalize:"off"},inputAutoTrim:!0,inputAutoFocus:!0,inputPlaceholder:"Enter Evacuee ID Manually",showCancelButton:!0,confirmButtonText:"Look up",showLoaderOnConfirm:!0,preConfirm:t=>Qe(t).then(({success:i,CurrentlyEvacuatedAt:c})=>R(i?c?{...c,evacId:t}:t:null).json()).catch(()=>R(null).json()),allowOutsideClick:()=>!S.isLoading()});m.useEffect(()=>{var t,i,c,d,l,n,o,u,g,D,f,w,C;N.state==="idle"&&(L?((t=r==null?void 0:r.loginInfo)==null?void 0:t.Role)==="admin"?(r==null?void 0:r.myAssignedEvent)===null?(A("..",{replace:!0}),h.fire({icon:"error",title:"Invalid Access! You have not selected any Evacuation Event ID."}).then()):((d=(i=r==null?void 0:r.myAssignedEvent)==null?void 0:i.Assigned)!=null&&d.includes((c=r==null?void 0:r.loginInfo)==null?void 0:c.ID)&&Oe(r.myAssignedEvent.ID,r.loginInfo.ID).catch(()=>{A("..",{replace:!0}),h.fire({icon:"error",title:"Something went wrong! Please Try Again."}).then()}),H||setTimeout(()=>$(!0),1e3)):(l=r==null?void 0:r.loginInfo)!=null&&l.Permissions.includes("pre-evacuation-scan")&&((u=(o=(n=r==null?void 0:r.myAssignedEvent)==null?void 0:n.PreEvacuation)==null?void 0:o.Started)==null?void 0:u.getTime())<=Date.now()&&(!((D=(g=r==null?void 0:r.myAssignedEvent)==null?void 0:g.PreEvacuation)!=null&&D.Ended)||((C=(w=(f=r==null?void 0:r.myAssignedEvent)==null?void 0:f.PreEvacuation)==null?void 0:w.Ended)==null?void 0:C.getTime())>Date.now())?H||setTimeout(()=>$(!0),1e3):A("..",{replace:!0}):(r!=null&&r.myAssignedEvent||(r==null?void 0:r.myAssignedEvent)===null)&&we(!0))},[r,r==null?void 0:r.loginInfo,r==null?void 0:r.myAssignedEvent,N==null?void 0:N.state,A,H,L]),m.useEffect(()=>{var t;if(N.state==="idle"&&H)if((t=r==null?void 0:r.myAssignedEvent)!=null&&t.ID)Fe(r.myAssignedEvent.ID,"pre").then(({success:i})=>{e!==i&&T(i),$(!1)}).catch(i=>{console.error(i),$(!1)});else return()=>{W(!1),x(!1),p(null),$(!1),v({}),T({}),y([])}},[N.state,e,H,(F=r==null?void 0:r.myAssignedEvent)==null?void 0:F.ID]),m.useEffect(()=>{(P&&j!==null||b===!0&&j!==null)&&ze(j).then(({success:t})=>{if(t)if(!t.CurrentlyEvacuatedAt)y([]),v(t),setTimeout(()=>M==null?void 0:M.scrollIntoView({behavior:"smooth"}),15),x(!1);else{const{ID:i,District:c,StreetNum:d,Barangay:l,Municipality:n,Province:o,Region:u,ZipCode:g}=t.CurrentlyEvacuatedAt;x(!1),p(null),h.fire({icon:"warning",title:`Household ID ${t.HouseID} Already Evacuated!`,text:`${t.HouseID} is currently evacuated to ${i} @ District ${c} ${d}, ${l}, ${n}, ${o}, ${u}, ${g}`}).then()}}).catch(console.error)},[M,j,P,s,b]);const Ae=m.useCallback(t=>{t!==null&&j!==t&&(p(t),y([]))},[j]),Me=m.useCallback(()=>{var t;return e&&((t=e.PreEvacuation)==null?void 0:t.Evacuated)instanceof Array?e.PreEvacuation.Evacuated.map(({ID:{HouseID:i}})=>i):[]},[e]),ke=m.useCallback(()=>{var t;return e&&((t=e.PreEvacuation)==null?void 0:t.Evacuated)instanceof Array?e.PreEvacuation.Evacuated.map(({ID:{Household:{Head:i,Members:c}},Present:d},l)=>{const n=["table-light","table-warning","table-secondary","table-info","table-danger"],o=c.reduce((u,g)=>[...u,{Name:g.Name,Suffx:g.Suffx,Age:g.Age}],[i?{Name:i.Name,Suffx:i.Suffx,Age:i.Age}:[]]);return a.jsx("div",{className:"table-responsive",children:a.jsx("table",{className:`table table-striped-columns table-bordered shadow-sm ${n[l%n.length]}`,children:a.jsx("tbody",{children:o.map((u,g)=>a.jsxs("tr",{children:[a.jsx("td",{scope:"row",children:`${u.Name} ${!u.Suffx||u.Suffx==="none"?"":u.Suffx}`}),a.jsx("td",{children:u.Age}),a.jsx("td",{children:d.includes(u.Name)?a.jsx(qe,{color:"success"}):a.jsx(Ge,{color:"error"})})]},`pre-evacuation-occupants-tr-${g}`))})})},`pre-evacuation-occupants-${l}`)}):[]},[e]),Q=m.useCallback(t=>{var i,c,d,l;t.preventDefault(),t.target.value&&(((c=(i=s==null?void 0:s.Household)==null?void 0:i.Head)==null?void 0:c.Name)===t.target.value||(l=(d=s==null?void 0:s.Household)==null?void 0:d.Members)!=null&&l.map(n=>n.Name).includes(t.target.value))&&(t.target.checked&&!E.includes(t.target.value)?y(n=>[...n,t.target.value]):!t.target.checked&&E.includes(t.target.value)&&y(n=>n.filter(o=>o!==t.target.value)))},[E,(z=s==null?void 0:s.Household)==null?void 0:z.Head,(Z=s==null?void 0:s.Household)==null?void 0:Z.Members]),O=m.useCallback(t=>{var i;return((i=e==null?void 0:e.PreEvacuation)==null?void 0:i.Evacuated.reduce((c,{ID:{HouseID:d},Present:l})=>c||(s==null?void 0:s.HouseID)===d&&l.includes(t),!1))||(E==null?void 0:E.includes(t))},[(V=e==null?void 0:e.PreEvacuation)==null?void 0:V.Evacuated,E,s==null?void 0:s.HouseID]),Re=m.useCallback(t=>{var c,d;if(t.preventDefault(),t.stopPropagation(),E.length===0){h.fire({icon:"info",title:"Select evacuee/s physically present."}).then();return}const i=s==null?void 0:s.HouseID;((d=(c=e==null?void 0:e.PreEvacuation)==null?void 0:c.Evacuated)==null?void 0:d.length)>0&&e.PreEvacuation.Evacuated.map(l=>l.ID.HouseID).includes(s.HouseID)&&h.fire({icon:"info",title:`Already Registered Evacuee ID ${i}. Let the evacuee proceed.`,text:`Present: ${k(i)} persons`}).then(()=>{v({}),p(null)}),Ze(e==null?void 0:e.ID,i,E).then(({success:l,error:n})=>{var o,u,g,D,f,w;n?(h.fire({icon:"warning",title:"Already Evacuated!",text:`${n}`}).then(()=>{v({}),y([])}),b&&x(!1),p(null)):l?(h.fire({icon:"success",title:`Successfully Registered Evacuee ID ${i}`,text:`${(u=(o=l==null?void 0:l.PreEvacuation)==null?void 0:o.Evacuated)==null?void 0:u.reduce((C,Ce)=>Ce.ID===i?Ce.Present.length:C,0)} persons may now proceed.`}).then(()=>{y([]),v({})}),b&&x(!1),p(null)):(D=(g=e==null?void 0:e.PreEvacuation)==null?void 0:g.Evacuated)!=null&&D.map(C=>C.ID.HouseID).includes(i)?(h.fire({icon:"info",title:`Already Registered Evacuee ID ${i}. Let the evacuee proceed.`,text:`Present: ${k(i)} persons`}).then(()=>{v({}),y([])}),b&&x(!1),p(null)):(e==null?void 0:e.MaxCapacity)===((w=(f=e==null?void 0:e.PreEvacuation)==null?void 0:f.Evacuated)==null?void 0:w.length)?(h.fire({icon:"error",title:"Maximum Building Capacity has been reached!",text:"Cannot proceed any further."}).then(()=>{v({}),y([])}),b&&x(!1),p(null)):h.fire({icon:"error",title:`Failed to Registered Evacuee ID ${i}. Please Try Again!`}).then()}).catch(()=>{var l,n,o,u;(n=(l=e==null?void 0:e.PreEvacuation)==null?void 0:l.Evacuated)!=null&&n.map(g=>g.ID.HouseID).includes(i)?(h.fire({icon:"info",title:`Already Registered Evacuee ID ${i}. Let the evacuee proceed.`,text:`Present: ${k(i)} persons`}).then(()=>{v({}),y([])}),b&&x(!1),p(null)):(e==null?void 0:e.MaxCapacity)===((u=(o=e==null?void 0:e.PreEvacuation)==null?void 0:o.Evacuated)==null?void 0:u.length)?(h.fire({icon:"error",title:"Maximum Building Capacity has been reached!",text:"Cannot proceed any further."}).then(()=>{v({}),y([])}),b&&x(!1),p(null)):h.fire({icon:"error",title:`Failed to Registered Evacuee ID ${i}. Please Try Again!`}).then()})},[E,(Y=e==null?void 0:e.PreEvacuation)==null?void 0:Y.Evacuated,e==null?void 0:e.ID,e==null?void 0:e.MaxCapacity,s.HouseID,h,b]),Te=m.useCallback(t=>{t.preventDefault(),B.fire({title:"Evacuee QR ID"}).then(i=>{if(i.isConfirmed)if(i.value)if(typeof i.value=="object"){const{evacId:c,ID:d,District:l,StreetNum:n,Barangay:o,Municipality:u,Province:g,Region:D,ZipCode:f}=i.value;x(!1),p(null),h.fire({icon:"warning",title:`Household ID ${c} has Already Evacuated!`,text:`${c} currently evacuated to ${d} @ District ${l} ${n}, ${o}, ${u}, ${g}, ${D}, ${f}`}).then()}else b||x(!0),p(i.value);else x(!1),p(null),h.fire({icon:"info",title:"Evacuation ID not found!"}).then()})},[B,h,b]),k=m.useCallback(t=>{var i,c;return((c=(i=e==null?void 0:e.PreEvacuation)==null?void 0:i.Evacuated)==null?void 0:c.reduce((d,l)=>(t?l.ID.HouseID===t:l.ID.HouseID===(s==null?void 0:s.HouseID))?l.Present.length:d,0))||0},[e,s]);return a.jsxs(a.Fragment,{children:[!(e!=null&&e.ID)&&a.jsx(Ve,{}),a.jsx("div",{className:"container pt-3",children:a.jsx(Ue,{items:[{title:"Home",href:"/"},{title:"Pre-evacuation",href:"/pre-evacuation"},{title:"QR Scanning",href:"."},{title:e==null?void 0:e.ID}]})}),a.jsx("div",{className:"container mb-5 pb-3 main-container bg-light bg-opacity-50",children:a.jsxs("div",{className:"row overflow-hidden w-100 h-100 my-auto mx-auto mx-lg-0",children:[a.jsx("div",{className:"col-12 col-md-9 col-lg-8 my-3",children:a.jsxs("div",{className:"card h-100",children:[a.jsx("div",{className:"card-header h2",children:"Pre-Evacuation QR Scan"}),a.jsxs("div",{className:"card-body d-flex flex-column justify-content-center align-items-center",children:[a.jsxs("div",{className:"mt-3",children:[a.jsx(Je,{className:"border border-2 rounded-5 mx-auto",videoClassName:"rounded-5",onResult:Ae,start:P,style:{width:"300px",height:"300px"}}),a.jsxs("div",{className:"mt-3 d-flex flex-row justify-content-evenly",children:[a.jsx("button",{onClick:()=>W(!P),type:"button",className:`btn btn-outline-${P?"danger":"primary"}`,children:P?"Stop Scanning":"Scan Qr Code"}),a.jsx("button",{onClick:Te,type:"button",className:"btn btn-outline-secondary",children:"Manual QR Code"})]})]}),a.jsxs("div",{className:"mt-3",children:["Scanned ID: ",j]}),a.jsxs("div",{className:"d-flex align-items-center justify-content-center mt-5 h4 w-100",children:[a.jsx("div",{className:"border border-2 ps-3 py-2 text-start bg-success-subtle",style:{minWidth:"10em",maxWidth:"20em"},children:"Available Tents:"}),a.jsx("div",{className:`border border-2 text-center py-2 text-light bg-${(_=e==null?void 0:e.PreEvacuation)!=null&&_.Evacuated&&(e!=null&&e.MaxCapacity)&&e.PreEvacuation.Evacuated.length>=e.MaxCapacity?"danger":(q=e==null?void 0:e.PreEvacuation)!=null&&q.Evacuated&&(e!=null&&e.MaxCapacity)&&e.MaxCapacity-e.PreEvacuation.Evacuated.length<5?"warning text-dark":"success-subtle text-dark"}`,style:{minWidth:"3em",maxWidth:"3em"},children:(G=e==null?void 0:e.PreEvacuation)!=null&&G.Evacuated&&(e!=null&&e.MaxCapacity)?e.MaxCapacity-((J=e==null?void 0:e.PreEvacuation)==null?void 0:J.Evacuated.length):"-"})]}),a.jsxs("div",{className:"d-flex align-items-center justify-content-center mt-3 h4 w-100",children:[a.jsx("div",{className:"border border-2 ps-3 py-2 text-start bg-info-subtle",style:{minWidth:"10em",maxWidth:"20em"},children:"Occupied Tents:"}),a.jsx("div",{className:`border border-2 text-center py-2 text-light bg-${(K=e==null?void 0:e.PreEvacuation)!=null&&K.Evacuated&&e.MaxCapacity&&e.PreEvacuation.Evacuated.length>=(e==null?void 0:e.MaxCapacity)?"danger":(U=e==null?void 0:e.PreEvacuation)!=null&&U.Evacuated&&(e!=null&&e.MaxCapacity)&&e.MaxCapacity-e.PreEvacuation.Evacuated.length<5?"warning text-dark":"info-subtle text-dark"}`,style:{minWidth:"3em",maxWidth:"3em"},children:(X=e==null?void 0:e.PreEvacuation)!=null&&X.Evacuated?e.PreEvacuation.Evacuated.length:"-"})]}),a.jsxs("div",{className:"d-flex align-items-center justify-content-center mt-3 h4 w-100",children:[a.jsx("div",{className:"border border-2 ps-3 py-2 text-start bg-warning-subtle",style:{minWidth:"10em",maxWidth:"20em"},children:"Total Tents:"}),a.jsx("div",{className:`border border-2 text-center py-2 text-light bg-${(I=e==null?void 0:e.PreEvacuation)!=null&&I.Evacuated&&(e!=null&&e.MaxCapacity)&&e.PreEvacuation.Evacuated.length>=e.MaxCapacity?"danger":(ee=e==null?void 0:e.PreEvacuation)!=null&&ee.Evacuated&&(e!=null&&e.MaxCapacity)&&e.MaxCapacity-e.PreEvacuation.Evacuated.length<5?"warning text-dark":"warning-subtle text-dark"}`,style:{minWidth:"3em",maxWidth:"3em"},children:(e==null?void 0:e.MaxCapacity)||"-"})]}),a.jsxs("div",{className:"d-flex align-items-center justify-content-center mt-3 h4 w-100",children:[a.jsx("div",{className:"border border-2 ps-3 py-2 text-start bg-danger-subtle",style:{minWidth:"10em",maxWidth:"20em"},children:"No. of Persons:"}),a.jsx("div",{className:"border border-2 text-center py-2 text-bg-info",style:{minWidth:"3em",maxWidth:"3em"},children:((te=(ae=e==null?void 0:e.PreEvacuation)==null?void 0:ae.Evacuated)==null?void 0:te.reduce((t,i)=>t+i.Present.length,0))||"-"})]})]}),a.jsx("div",{className:"card-footer"})]})}),a.jsx("div",{className:"col my-3",children:a.jsxs("div",{className:"card h-100",children:[j&&(s==null?void 0:s.HouseID)&&a.jsx("div",{className:"card-header h3",children:s==null?void 0:s.HouseID}),a.jsx("div",{className:"card-body position-relative",style:{float:"left",clear:"both"},ref:Se,children:j&&(s==null?void 0:s.HouseID)&&a.jsxs("form",{onSubmit:Re,children:[a.jsx("h4",{children:"Head"}),a.jsx("div",{className:"table-responsive",children:a.jsx("table",{className:"table table-striped-columns table-warning",children:a.jsx("tbody",{children:a.jsxs("tr",{children:[a.jsx("td",{scope:"row",className:"text-start",children:a.jsx(He,{className:"w-100 ps-1 my-0",disabled:((ie=(se=e==null?void 0:e.PreEvacuation)==null?void 0:se.Evacuated)==null?void 0:ie.filter(({ID:{HouseID:t}})=>t===(s==null?void 0:s.HouseID)).length)>0,control:a.jsx($e,{value:(le=(re=s.Household)==null?void 0:re.Head)==null?void 0:le.Name,color:"primary",checked:O((ne=(ce=s==null?void 0:s.Household)==null?void 0:ce.Head)==null?void 0:ne.Name),onChange:Q,name:"head"}),label:((ue=(de=s.Household)==null?void 0:de.Head)==null?void 0:ue.Name)+(((me=(oe=s.Household)==null?void 0:oe.Head)==null?void 0:me.Suffx)!=="none"?` ${((ge=(he=s.Household)==null?void 0:he.Head)==null?void 0:ge.Suffx)||""}`:""),name:"head"})}),a.jsxs("td",{className:"py-3",children:["(age: ",(xe=(pe=s.Household)==null?void 0:pe.Head)==null?void 0:xe.Age,")"]})]})})})}),a.jsxs("h4",{children:["Members",` (+${(Ee=s.Household)==null?void 0:Ee.Members.length})`]}),a.jsx("div",{className:"overflow-y-auto overflow-x-hidden border",style:{height:"20em"},children:a.jsx("div",{className:"table-responsive",children:a.jsx("table",{className:"table table-striped-columns",children:a.jsx("tbody",{children:((ye=s.Household)==null?void 0:ye.Members.length)>0&&((be=s.Household)==null?void 0:be.Members.map((t,i)=>{var c,d,l,n;return a.jsxs("tr",{children:[a.jsx("td",{scope:"row",className:"text-start",children:a.jsx(He,{className:"w-100 ps-1 my-0",disabled:((d=(c=e==null?void 0:e.PreEvacuation)==null?void 0:c.Evacuated)==null?void 0:d.filter(({ID:{HouseID:o}})=>o===(s==null?void 0:s.HouseID)).length)>0,control:a.jsx($e,{value:t.Name,color:"primary",checked:O(t.Name),onChange:Q,name:`member${i}`,readonly:((n=(l=e==null?void 0:e.PreEvacuation)==null?void 0:l.Evacuated)==null?void 0:n.filter(({ID:{HouseID:o}})=>o===(s==null?void 0:s.HouseID)).length)>0}),label:t.Name+(t.Suffx!=="none"?` ${t.Suffx||""}`:""),name:`member${i}`})}),a.jsxs("td",{className:"py-3",children:["(age: ",t.Age,")"]})]},`members_${i}${t.Name.split(" ")[0]}`)}))})})})}),a.jsx("br",{}),a.jsxs("div",{className:"w-100 pe-4",children:[a.jsx(Xe,{severity:((je=(ve=e==null?void 0:e.PreEvacuation)==null?void 0:ve.Evacuated)==null?void 0:je.length)>0&&e.PreEvacuation.Evacuated.map(t=>t.ID.HouseID).includes(s.HouseID)?"warning":"info",className:"mb-2",children:((fe=(De=e==null?void 0:e.PreEvacuation)==null?void 0:De.Evacuated)==null?void 0:fe.length)>0&&e.PreEvacuation.Evacuated.map(t=>t.ID.HouseID).includes(s.HouseID)?`${s.HouseID} has already evacuated! Present: ${k()} persons`:`Please select evacuees physically present. Selected: ${E.length} persons`}),a.jsx("button",{type:"submit",className:`btn btn-success me-2 ${((Pe=(Ne=e==null?void 0:e.PreEvacuation)==null?void 0:Ne.Evacuated)==null?void 0:Pe.length)>0&&e.PreEvacuation.Evacuated.map(t=>t.ID.HouseID).includes(s.HouseID)?"disabled":""}`,children:"Confirm"}),a.jsx("button",{type:"reset",className:"btn btn-secondary ms-2",onClick:()=>{p(null),v({})},children:"Cancel"})]})]})}),a.jsx("div",{className:"card-footer position-relative",style:{maxHeight:"20em"},children:a.jsx(Ke,{name:"pre-evacuation",labels:Me(),contents:ke(),style:{maxHeight:"19em",fontSize:"10pt"},contentStyle:{maxHeight:"19em",fontSize:"10pt",textAlign:"left"}})})]})})]})})]})}export{da as Component,na as loader};
